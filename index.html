<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="format-detection" content="telephone=no" />
  <title>IngressAI — Ingressos em minutos, direto no WhatsApp</title>
  <meta name="description" content="Compre ingressos em minutos pelo WhatsApp. Vitrine por cidade, checkout instantâneo, repasse instantâneo (T+0) e validação por QR Code." />
  <meta name="robots" content="index,follow,max-image-preview:large" />
  <link rel="canonical" href="https://ingressai.chat/" />
  <meta property="og:title" content="IngressAI — Ingressos em minutos" />
  <meta property="og:description" content="Vitrine por cidade, checkout instantâneo, QR Code antifraude e repasse instantâneo (T+0)." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://ingressai.chat/" />
  <meta property="og:image" content="https://ingressai.chat/logo_ingressai.png" />
  <meta property="og:site_name" content="IngressAI" />
  <meta property="og:locale" content="pt_BR" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="color-scheme" content="light" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="icon" href="/favicon.png" type="image/png" sizes="32x32" />
  <link rel="preload" as="image" href="/logo_ingressai.png" />
  <style>
    /* ===== Base (mobile-first) ===== */
    :root{
      --phi:1.618;
      --s0:8px;
      --s1:calc(var(--s0)*var(--phi));
      --s2:calc(var(--s1)*var(--phi));
      --s3:calc(var(--s2)*var(--phi));
      --s4:calc(var(--s3)*var(--phi));
      --fs-0:16px;
      --lh:1.45;
      --ink:#0b1220;
      --muted:#56667f;
      --bg:#fbfdff;
      --card:#ffffff;
      --blue:#2F7DD9;
      --blue-strong:#1B5FB3;
      --shadow:0 10px 28px rgba(47,125,217,.08);
      --shadow-soft:0 6px 18px rgba(47,125,217,.06);
      --radius:14px;
      --radius-sm:10px;
      --container-max:1100px;
      --btn-h:48px;
      --t-fast:.18s;
      --t-med:.28s;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:var(--fs-0)/var(--lh) -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,system-ui,sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--container-max);margin:0 auto;padding:0 var(--s2)}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid rgba(15,40,80,.04);z-index:40}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 0}
    .brand-row{display:flex;align-items:center;gap:12px}
    .logo{height:44px;width:auto}
    .nav-actions{display:flex;gap:10px;align-items:center}

    /* Hero */
    .hero{padding:28px 0 16px;text-align:center}
    .hero h1{margin:8px 0 6px;font-weight:800;font-size:clamp(20px,6vw,36px);line-height:1.06}
    .hero p{margin:0;color:var(--muted);max-width:760px;margin-left:auto;margin-right:auto}

    /* CTAs */
    .cta-inline{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:14px 0}
    .btn{height:var(--btn-h);padding:0 14px;border-radius:999px;border:1px solid rgba(47,125,217,.12);display:inline-flex;align-items:center;justify-content:center;font-weight:800;background:#fff;cursor:pointer;transition:transform .08s,box-shadow var(--t-fast)}
    .btn:active{transform:translateY(1px)}
    .btn--primary{background:linear-gradient(180deg,var(--blue),var(--blue-strong));color:#fff;border:0;box-shadow:var(--shadow-soft)}
    .btn--ghost{background:#fff;border:1px solid rgba(15,40,80,.06);color:var(--blue)}
    .small{height:40px;padding:0 10px;font-size:.95rem}

    /* Features */
    .features{display:grid;gap:12px;margin-top:18px;grid-template-columns:repeat(2,1fr)}
    @media(min-width:900px){.features{grid-template-columns:repeat(4,1fr)}}
    .feature{background:var(--card);border-radius:12px;padding:12px;border:1px solid rgba(15,40,80,.04);box-shadow:var(--shadow-soft);text-align:center}
    .feature strong{display:block}

    /* Vitrine */
    .section{padding:28px 0}
    .section h2{margin:0 0 12px;font-size:clamp(18px,4vw,24px)}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:12px}
    .search input{width:100%;padding:12px;border-radius:999px;border:1px solid rgba(15,40,80,.05);font-weight:600}
    .chips{display:flex;gap:8px;overflow:auto}
    .chip{white-space:nowrap;padding:.45rem .85rem;border-radius:999px;border:1px solid rgba(15,40,80,.04);background:#fff;font-weight:800;cursor:pointer}
    .chip[aria-selected="true"]{background:var(--blue);color:#fff;border-color:transparent;box-shadow:var(--shadow-soft)}

    .cards{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:700px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1000px){.cards{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border-radius:12px;padding:12px;border:1px solid rgba(15,40,80,.04);box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px;cursor:pointer}
    .card-media{background:linear-gradient(180deg,#fff,#f5f9ff);height:160px;border-radius:10px;display:grid;place-items:center;overflow:hidden}
    .card-media img{width:100%;height:100%;object-fit:cover}
    .card-title{font-weight:800}
    .card-meta{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .status{font-weight:800;color:var(--blue-strong)}

    /* Organizers panel (improved) */
    #organizadores{padding:22px 0;background:linear-gradient(180deg,#ffffff, #fbfdff)}
    .org-wrap{display:grid;gap:14px}
    /* Golden ratio layout: main (≈1.618) + side */
    .org-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:1020px){ .org-grid{grid-template-columns:1.62fr 1fr;align-items:start} }

    .std-card{background:var(--card);border-radius:12px;padding:12px;border:1px solid rgba(15,40,80,.04);box-shadow:var(--shadow-soft)}
    .model-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .model{background:#fff;border-radius:12px;border:1px solid rgba(15,40,80,.04);padding:12px;font-weight:800;text-align:center;cursor:pointer}
    .model[aria-selected="true"]{background:linear-gradient(180deg,var(--blue),var(--blue-strong));color:#fff;box-shadow:var(--shadow)}

    .fee-row{display:flex;justify-content:flex-start;gap:10px;align-items:center}
    .fee-chip{padding:.5rem .75rem;border-radius:999px;background:#f0f7ff;border:1px solid rgba(47,125,217,.12);color:var(--blue-strong);font-weight:800}

    .org-panel{background:var(--card);border-radius:12px;padding:12px;border:1px solid rgba(15,40,80,.04);box-shadow:var(--shadow)}
    .panel-grid{display:grid;gap:12px}
    @media(min-width:820px){ .panel-grid{grid-template-columns:1fr} }

    .disclosure__summary{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;border:1px solid rgba(15,40,80,.04);background:#fff;cursor:pointer;font-weight:800}

    /* Calculadora / setup */
    .calc{display:grid;gap:10px}
    .calc-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .calc input, .calc select, .calc textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(15,40,80,.05);font:inherit}
    .calc small{color:var(--muted)}
    .calc-result{background:#fff;border:1px dashed rgba(15,40,80,.04);border-radius:10px;padding:10px;font-weight:800;display:flex;justify-content:space-between;align-items:center}

    .panel-cta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .is-disabled{opacity:.6;pointer-events:none}

    /* Bottom sheet */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(11,18,32,.36);opacity:0;pointer-events:none;transition:opacity var(--t-fast);z-index:50}
    .sheet-backdrop.is-open{opacity:1;pointer-events:auto}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;transform:translateY(100%);transition:transform var(--t-med);padding:12px;z-index:60}
    .sheet.is-open{transform:translateY(0)}
    .sheet-body{max-height:70vh;overflow:auto}

    footer{padding:18px 0;margin-top:28px;border-top:1px solid rgba(15,40,80,.03);background:#fff}
    .foot{display:flex;flex-direction:column;gap:8px;align-items:center}

    /* Accessibility */
    :focus{outline:3px solid rgba(47,125,217,.12);outline-offset:2px}
  </style>
</head>
<body>
  <header role="banner">
    <div class="container nav">
      <div class="brand-row">
        <img src="/logo_ingressai.png" alt="IngressAI" class="logo" />
        <div style="font-weight:800">IngressAI</div>
      </div>
      <div class="nav-actions">
        <a class="btn small btn--ghost" href="/app/login" aria-label="Acessar dashboard">Dashboard</a>
      </div>
    </div>
  </header>

  <main class="container" role="main">
    <section class="hero" aria-labelledby="hero-title">
      <img src="/logo_ingressai.png" alt="" style="display:block;margin:0 auto;height:84px;width:auto;border-radius:16px" />
      <h1 id="hero-title">Ingressos em minutos, direto no WhatsApp</h1>
      <p>Vitrine por cidade, checkout instantâneo, QR Code antifraude e repasse imediato (T+0). Crie e gerencie seus eventos sem complicação.</p>

      <div class="cta-inline" style="margin-top:14px">
        <button id="cta-organizadores" class="btn btn--primary small" aria-expanded="false" aria-controls="organizadores">Soluções para organizadores ▾</button>
        <a class="btn small btn--ghost" href="/app/login" aria-label="Acessar dashboard">Acessar dashboard</a>
      </div>
    </section>

    <section class="proofs" aria-labelledby="proofs-title">
      <h2 id="proofs-title" class="sr-only">Provas de valor</h2>
      <div class="features container" style="padding:0">
        <div class="feature"><strong>Venda automatizada</strong><small>Via WhatsApp</small></div>
        <div class="feature"><strong>Repasse imediato</strong><small>Via Pix</small></div>
        <div class="feature"><strong>QR Code Antifraude</strong><small>Validador web</small></div>
        <div class="feature"><strong>Dashboard</strong><small>Controle completo</small></div>
      </div>
    </section>

    <section id="vitrine" class="section" aria-labelledby="vitrine-title">
      <h2 id="vitrine-title">Eventos em destaque</h2>

      <div class="filters">
        <div style="flex:1;min-width:220px">
          <label class="sr-only" for="busca-eventos">Buscar evento</label>
          <div class="search"><input type="search" id="busca-eventos" placeholder="Buscar evento" autocomplete="off" /></div>
        </div>
        <div id="filtro-cidades" class="chips" role="tablist" aria-label="Filtrar por cidade"></div>
      </div>

      <div class="cards" id="lista-eventos" aria-live="polite"></div>
    </section>

    <!-- ORGANIZADORES (hidden until opened) -->
    <section id="organizadores" class="section" aria-labelledby="orgs-title" hidden>
      <div class="org-wrap container">
        <h2 id="orgs-title">Soluções para organizadores</h2>

        <div class="org-grid">
          <!-- MAIN: informações e modelos + calculadora/setup -->
          <div>
            <div class="std-card">
              <ul style="margin:0;padding-left:1rem">
                <li>Setup do evento direto no site (pré-aprovação)</li>
                <li>Verificação por código e acesso ao Dashboard</li>
                <li>Geração automática de ingressos com QR Code</li>
                <li>Repasse imediato ao organizador</li>
              </ul>
            </div>

            <div style="height:12px"></div>

            <div class="org-panel">
              <div class="disclosure__summary" aria-hidden="true">
                <span style="font-weight:900">Calculadora & Setup</span>
                <span class="subtle">Passo a passo para criar e pré-aprovar seu evento</span>
              </div>

              <div style="padding-top:12px" class="panel-grid">
                <!-- Planos / modelos -->
                <div style="margin-bottom:12px">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <strong>Categoria</strong>
                    <small class="subtle">Taxa fixa por ingresso</small>
                  </div>
                  <div id="org-models" class="model-grid"></div>
                </div>

                <div class="fee-row"><span id="fee-chip" class="fee-chip">Selecione uma categoria</span></div>

                <!-- Calculadora -->
                <div style="margin-top:10px">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <strong>Calculadora rápida</strong>
                    <small class="subtle">Veja na hora o impacto da taxa fixa</small>
                  </div>

                  <div class="calc">
                    <div class="calc-row">
                      <div>
                        <label for="preco">Preço (R$)</label>
                        <input id="preco" type="text" inputmode="decimal" placeholder="60,00" disabled />
                      </div>
                      <div>
                        <label for="qtd">Qtd ingressos</label>
                        <input id="qtd" type="number" min="1" step="1" placeholder="1" disabled />
                      </div>
                    </div>

                    <div class="calc-result"><span>Total bruto</span><strong id="calc-gross">R$ 0,00</strong></div>
                    <div class="calc-result"><span>Taxa fixa</span><strong id="calc-fee">R$ 0,00</strong></div>
                    <div class="calc-result"><span>Você recebe</span><strong id="calc-net">R$ 0,00</strong></div>
                  </div>
                </div>

                <!-- Setup (stepper simplified) -->
                <div style="margin-top:14px">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <strong>Setup do evento</strong>
                    <small class="subtle">Preencha e solicite criação</small>
                  </div>

                  <div class="grid" style="display:grid;gap:8px">
                    <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
                      <input id="ev-nome" type="text" placeholder="Nome do evento" disabled />
                      <input id="ev-cidade" type="text" placeholder="Cidade" disabled />
                    </div>

                    <div class="grid" style="grid-template-columns:1fr 1fr 1fr;gap:8px">
                      <input id="ev-data" type="date" disabled />
                      <input id="ev-hora" type="time" disabled />
                      <input id="ev-cap" type="number" min="1" placeholder="Capacidade" disabled />
                    </div>

                    <input id="ev-local" type="text" placeholder="Local (ex.: Espaço Central)" disabled />
                    <textarea id="ev-desc" rows="2" placeholder="Descrição (opcional)" disabled></textarea>

                    <!-- Phone + code -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:end">
                      <div>
                        <label for="ev-phone" class="subtle">Seu WhatsApp</label>
                        <input id="ev-phone" type="tel" placeholder="55DDDNNNNNNNN" disabled />
                      </div>
                      <div>
                        <label for="ev-code" class="subtle">Código</label>
                        <input id="ev-code" type="text" placeholder="••••••" disabled />
                      </div>
                    </div>

                    <div style="display:flex;gap:8px;justify-content:flex-start">
                      <button id="setup-send-code" class="btn btn--ghost small is-disabled" aria-disabled="true">Enviar código</button>
                      <button id="setup-verify-code" class="btn btn--ghost small is-disabled" aria-disabled="true">Verificar</button>
                      <button id="setup-submit" class="btn btn--primary small is-disabled" aria-disabled="true">Solicitar criação</button>
                      <a class="btn small" href="/app/login">Acessar dashboard</a>
                    </div>

                    <small id="setup-status" class="subtle" aria-live="polite"></small>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- SIDE: quick info / help -->
          <aside>
            <div class="org-panel">
              <strong>Como funciona</strong>
              <ol style="margin:8px 0;padding-left:1rem;color:var(--muted)">
                <li>Escolha a categoria</li>
                <li>Calcule a taxa rapidamente</li>
                <li>Preencha o setup e peça criação</li>
                <li>Receba o código e acesse o Dashboard</li>
              </ol>
              <div style="margin-top:8px" class="panel-cta">
                <a href="https://wa.me/5534999992747" target="_blank" rel="noopener noreferrer" class="btn small btn--ghost">Falar com suporte</a>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </section>

    <section id="como-funciona" class="section" aria-labelledby="como-title">
      <h2 id="como-title">Como funciona</h2>
      <div class="cards" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px">
        <div class="card"><h3 class="card-title">Para quem compra</h3><ol style="margin:0;padding-left:1rem"><li>Escolha o evento</li><li>Pague via WhatsApp</li><li>Receba o ingresso com QR Code</li></ol></div>
        <div class="card"><h3 class="card-title">Para quem organiza</h3><ol style="margin:0;padding-left:1rem"><li>Faça o setup</li><li>Verifique o código</li><li>Gerencie no Dashboard</li></ol></div>
      </div>
    </section>

    <!-- bottom sheet for event details -->
    <div class="sheet-backdrop" id="sheet-backdrop" aria-hidden="true"></div>
    <aside class="sheet" id="sheet" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="sheet-body" id="sheet-body"></div>
    </aside>
  </main>

  <footer role="contentinfo">
    <div class="container foot">
      <div style="display:flex;gap:10px;align-items:center">
        <a class="btn small btn--ghost" href="mailto:contato@ingressai.chat" aria-label="Enviar e-mail">Email</a>
        <a class="btn small btn--ghost" href="https://instagram.com/ingressai" target="_blank" rel="noopener noreferrer">Instagram</a>
        <a class="btn small btn--ghost" href="https://wa.me/5534999992747" target="_blank" rel="noopener noreferrer">WhatsApp</a>
      </div>
      <div style="color:var(--muted);font-weight:600;margin-top:8px">IngressAI • CNPJ 42.948.399/0001-87</div>
    </div>
  </footer>

  <script>
    /* ========= CONFIG ========= */
    const API_PARAM = new URLSearchParams(location.search).get('api');
    const BASE = (API_PARAM || "https://ingressai-backend-production.up.railway.app").replace(/\/$/, "");
    const WHATSAPP_NUMBER = '5534999992747';

    /* ========= STATE ========= */
    let eventos = [];
    let evIndex = {};

    /* ========= HELPERS ========= */
    const $ = (id) => document.getElementById(id);
    function formatDate(iso){ try{ const d=new Date(iso); return d.toLocaleString('pt-BR',{dateStyle:'medium',timeStyle:'short'}); }catch{ return iso } }
    function waHref(text){ return `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`; }
    function abs(u){
      if(!u) return '';
      if(/^https?:\/\//i.test(u)) return u;
      if(u.startsWith('//')) return location.protocol + u;
      if(u.startsWith('/')) return BASE + u;
      return BASE + '/' + u.replace(/^\/+/,'');
    }
    async function fetchJson(url, opts){
      const r = await fetch(url, { cache:'no-store', headers:{ 'Accept':'application/json', ...(opts&&opts.headers||{}) }, ...opts });
      let j = null; try{ j = await r.json(); }catch{}
      if (!r.ok) throw new Error(j?.error || r.statusText || 'Request failed');
      return j;
    }
    const BRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    function money(v){ return BRL.format(Number(v||0)); }
    function parseBR(v){ return Number(String(v||'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',','.')) || 0; }

    /* ========= DOM refs ========= */
    const lista = $('lista-eventos');
    const inputBusca = $('busca-eventos');
    const chipsRow = $('filtro-cidades');
    const modelsBox = $('org-models');
    const feeRow = $('fee-row');
    const feeChip = $('fee-chip');
    const calcBox = $('calc-box');
    const calcGross = $('calc-gross');
    const calcFee = $('calc-fee');
    const calcNet = $('calc-net');
    const setupStatus = $('setup-status');
    const sheet = $('sheet');
    const sheetBackdrop = $('sheet-backdrop');
    const ctaOrganizadores = $('cta-organizadores');

    /* ========= HERO CTA: abrir organizadores ========= */
    function openOrganizadores(){
      const sec = $('organizadores');
      if(!sec) return;
      sec.removeAttribute('hidden');
      const btn = ctaOrganizadores;
      btn.setAttribute('aria-expanded','true');
      // smooth scroll
      const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      sec.scrollIntoView({ behavior: reduced ? 'auto' : 'smooth', block: 'start' });
      // focus first interactive
      setTimeout(()=>{ $('org-models')?.querySelector('button')?.focus?.(); }, 400);
    }
    ctaOrganizadores.addEventListener('click', (e)=>{
      e.preventDefault();
      const sec = $('organizadores');
      if (sec && sec.hasAttribute('hidden')) openOrganizadores();
      else { // toggle close
        sec.setAttribute('hidden',''); ctaOrganizadores.setAttribute('aria-expanded','false'); window.scrollTo({top:0,behavior:'smooth'});
      }
    });

    /* ========= VITRINE ========= */
    const MAIN_CITIES = ['Uberaba','Uberlândia','Belo Horizonte','Ribeirão Preto','Franca'];
    let selectedCity = 'Todas';
    let query = '';

    function normalizeStatusLabel(s){ if(!s) return ''; return String(s).replace('Últimos ingressos','Último lote'); }
    function filterEventos(data,q,city){
      const qn = (q||'').trim().toLowerCase();
      const citySel = city || 'Todas';
      return data.filter(ev=>{
        const evCidade = (ev.cidade||'').toLowerCase();
        const matchCity = citySel === 'Todas' ? true : evCidade === citySel.toLowerCase();
        const nome = (ev.nome||'').toLowerCase();
        const desc = (ev.descricao||'').toLowerCase();
        const matchQuery = !qn ? true : (nome.includes(qn) || desc.includes(qn));
        return matchCity && matchQuery;
      });
    }

    function buildChips(){
      chipsRow.innerHTML = '';
      const cities = Array.from(new Set(MAIN_CITIES.concat(eventos.map(e=>e.cidade).filter(Boolean))));
      ['Todas', ...cities].forEach(c=>{
        const btn = document.createElement('button');
        btn.className = 'chip';
        btn.type = 'button';
        btn.textContent = c;
        btn.setAttribute('role','tab');
        btn.setAttribute('aria-selected', c===selectedCity ? 'true' : 'false');
        btn.dataset.city = c;
        chipsRow.appendChild(btn);
      });
    }

    function renderCards(){
      const data = filterEventos(eventos, query, selectedCity);
      lista.innerHTML = '';
      if(!data.length){
        const empty = document.createElement('div'); empty.className='std-card';
        empty.innerHTML = '<strong>Sem eventos publicados ainda.</strong><br><span class="subtle">Volte em breve — estamos preparando novidades ✨</span>';
        lista.appendChild(empty); return;
      }
      data.forEach(ev=>{
        const statusLabel = normalizeStatusLabel(ev.status||'');
        const card = document.createElement('article');
        card.className = 'card';
        card.dataset.open = ev.id;
        card.tabIndex = 0;
        card.innerHTML = `
          <div class="card-media">${ ev.img ? `<img src="${ev.img}" alt="${ev.nome}">` : 'Mídia do evento' }</div>
          <div>
            <div class="card-title">${ev.nome}</div>
            <div class="card-meta"><div class="subtle">${ev.cidade || ''} · ${formatDate(ev.dataISO)}</div><div class="status">${statusLabel || 'Em breve'}</div></div>
          </div>
        `;
        lista.appendChild(card);
      });
    }

    chipsRow.addEventListener('click', (e)=>{
      const b = e.target.closest('button.chip'); if(!b) return;
      selectedCity = b.dataset.city;
      chipsRow.querySelectorAll('button.chip').forEach(x=>x.setAttribute('aria-selected','false'));
      b.setAttribute('aria-selected','true');
      renderCards();
    });

    let debounce;
    inputBusca.addEventListener('input', ()=>{ clearTimeout(debounce); debounce = setTimeout(()=>{ query = inputBusca.value; renderCards(); }, 180); });

    /* open sheet (event details) */
    function openSheet(ev){
      if(!ev) return;
      const body = $('sheet-body') || sheet;
      const mediaHTML = ev.img ? `<div class="card-media" style="height:220px;border-radius:12px;overflow:hidden"><img src="${ev.img}" alt="${ev.nome}" style="width:100%;height:100%;object-fit:cover"/></div>` : '<div class="card-media" style="height:220px;border-radius:12px;display:grid;place-items:center">Mídia do evento</div>';
      const html = `
        ${mediaHTML}
        <h3 style="margin:12px 0 6px">${ev.nome}</h3>
        <div style="color:var(--muted);margin-bottom:8px">${ev.cidade} • ${formatDate(ev.dataISO)}</div>
        <p style="color:var(--muted);margin:0 0 12px">${ev.descricao || ''}</p>
        <div style="display:flex;gap:8px">
          <a class="btn btn--primary small" href="${waHref(`ingressai:start ev=${ev.id}`)}" target="_blank" rel="noopener">Comprar pelo WhatsApp</a>
          <button id="sheet-close-btn" class="btn small btn--ghost">Fechar</button>
        </div>
      `;
      body.innerHTML = html;
      sheet.classList.add('is-open'); sheetBackdrop.classList.add('is-open');
      sheet.setAttribute('aria-hidden','false'); sheetBackdrop.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
      document.getElementById('sheet-close-btn')?.addEventListener('click', closeSheetSafe);
    }

    function closeSheetSafe(){
      sheet.classList.remove('is-open'); sheetBackdrop.classList.remove('is-open');
      sheet.setAttribute('aria-hidden','true'); sheetBackdrop.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }

    sheetBackdrop.addEventListener('click', closeSheetSafe);
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && sheet.classList.contains('is-open')) closeSheetSafe(); });

    lista.addEventListener('click', (e)=>{
      const card = e.target.closest('article.card[data-open], article.card');
      if(!card) return;
      const id = card.dataset.open;
      const ev = evIndex[id];
      if(!ev) return;
      openSheet(ev);
    });
    lista.addEventListener('keydown', (e)=>{
      const card = e.target.closest('article.card');
      if(!card) return;
      if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); const ev = evIndex[card.dataset.open]; if(ev) openSheet(ev); }
    });

    /* ========= ORGANIZADORES: models, calculator, setup ========= */
    const categorias = [
      { key:'aret', title:'Atléticas & Repúblicas', feeLabel:'R$ 2,00 por ingresso', feeFixed:2.00 },
      { key:'proloc', title:'Produtoras & Locais independentes', feeLabel:'R$ 2,50 por ingresso', feeFixed:2.50 }
    ];

    function renderModels(){
      modelsBox.innerHTML = '';
      categorias.forEach(c=>{
        const btn = document.createElement('button');
        btn.type='button';
        btn.className='model';
        btn.textContent = c.title;
        btn.dataset.key = c.key;
        btn.dataset.fee = String(c.feeFixed);
        modelsBox.appendChild(btn);
      });
    }

    function computeGross(preco,qtd){ return Math.max(0, Number(preco)||0) * Math.max(1, parseInt(qtd||1,10)); }
    function computeFeeFixed(qtd,feeFixed){ return Math.max(1,parseInt(qtd||1,10)) * Math.max(0,Number(feeFixed)||0); }
    function computeNet(preco,qtd,feeFixed){
      const bruto = computeGross(preco,qtd);
      const taxa = computeFeeFixed(qtd,feeFixed);
      return { bruto, taxa, liquido: Math.max(0, Number((bruto - taxa).toFixed(2))) };
    }

    function enableSetupFields(enable){
      ['preco','qtd','ev-nome','ev-cidade','ev-data','ev-hora','ev-cap','ev-local','ev-desc','ev-phone','ev-code'].forEach(id=>{
        const el = document.getElementById(id); if(!el) return; el.disabled = !enable;
      });
      ['setup-send-code','setup-verify-code','setup-submit'].forEach(id=>{
        const el = document.getElementById(id); if(!el) return;
        if(enable){ el.removeAttribute('aria-disabled'); el.classList.remove('is-disabled'); } else { el.setAttribute('aria-disabled','true'); el.classList.add('is-disabled'); }
      });
    }

    function setStatus(msg,type){ setupStatus.textContent = msg || ''; setupStatus.style.color = type==='error' ? '#b64848' : type==='ok' ? 'var(--blue-strong)' : ''; }

    function getSetupPayload(){
      const nome = $('ev-nome').value.trim();
      const cidade = $('ev-cidade').value.trim();
      const data = $('ev-data').value;
      const hora = $('ev-hora').value;
      const cap = parseInt($('ev-cap').value||'0',10);
      const local = $('ev-local').value.trim();
      const desc = $('ev-desc').value.trim();
      const preco = parseBR($('preco').value||'0');
      const qtd = Math.max(1, parseInt($('qtd').value||'1',10));
      const feeFixed = Number(calcBox?.dataset?.feeFixed)||0;
      const categoriaKey = calcBox?.dataset?.planKey || '';
      const startISO = (data && hora) ? new Date(`${data}T${hora}:00`).toISOString() : '';
      return { nome, cidade, startISO, capacidade:cap, local, descricao:desc, preco, qtd, feeFixed, categoriaKey };
    }

    async function applyPlan(key){
      const plan = categorias.find(x=>x.key===key) || null;
      calcBox.dataset.planKey = plan ? plan.key : '';
      if(plan){
        feeChip.textContent = 'Taxa fixa ' + plan.feeLabel;
        feeRow.classList.add('is-visible');
        calcBox.dataset.feeFixed = String(plan.feeFixed);
        enableSetupFields(true);
      } else {
        feeChip.textContent = 'Selecione uma categoria';
        feeRow.classList.remove('is-visible');
        calcBox.dataset.feeFixed = '';
        enableSetupFields(false);
      }

      // listeners da calculadora
      const precoEl = $('preco'); const qtdEl = $('qtd');
      const recompute = ()=>{
        const feeFixed = Number(calcBox.dataset.feeFixed)||0;
        const p = parseBR(precoEl.value||'0');
        const q = Math.max(1, parseInt(qtdEl.value||'1',10));
        const { bruto, taxa, liquido } = computeNet(p,q,feeFixed);
        calcGross.textContent = money(bruto);
        calcFee.textContent = money(taxa);
        calcNet.textContent = money(liquido);
      };
      precoEl.removeEventListener?.('input', recompute);
      qtdEl.removeEventListener?.('input', recompute);
      precoEl.addEventListener('input', recompute); qtdEl.addEventListener('input', recompute);
      recompute();

      // setup actions
      const btnSend = $('setup-send-code');
      const btnVerify = $('setup-verify-code');
      const btnSubmit = $('setup-submit');
      const phoneEl = $('ev-phone'); const codeEl = $('ev-code');

      calcBox.dataset.verified = 'false';
      calcBox.dataset.session = '';

      btnSend.onclick = async ()=>{
        try{
          const phone = (phoneEl.value||'').trim();
          if(!phone){ setStatus('Informe o WhatsApp no formato 55DDDNNNNNNNN.', 'error'); return; }
          setStatus('Enviando código…');
          try{
            const j = await fetchJson(`${BASE}/setup/start`, { method:'POST', body: JSON.stringify({ phone }), headers:{'Content-Type':'application/json'} });
            calcBox.dataset.session = j?.sessionId || '';
            setStatus('Código enviado. Confira seu WhatsApp.', 'ok');
          } catch (err){
            // fallback: open wa
            const msg = `ingressai:setup start phone=${phone}`;
            window.open(waHref(msg), '_blank', 'noopener');
            setStatus('Abrimos seu WhatsApp para confirmar o envio do código.', 'ok');
          }
        }catch(e){ setStatus('Falha ao enviar código.', 'error'); }
      };

      btnVerify.onclick = async ()=>{
        try{
          const phone=(phoneEl.value||'').trim();
          const code=(codeEl.value||'').trim();
          if(!phone||!code){ setStatus('Informe WhatsApp e o código recebido.', 'error'); return; }
          setStatus('Verificando código…');
          try{
            const j = await fetchJson(`${BASE}/setup/verify`, { method:'POST', body: JSON.stringify({ phone, code, sessionId: calcBox.dataset.session||'' }), headers:{'Content-Type':'application/json'} });
            if(j?.ok || j?.verified){ calcBox.dataset.verified='true'; setStatus('Código verificado! Você já pode solicitar a criação.', 'ok'); }
            else throw new Error('Código inválido');
          }catch{
            const msg = `ingressai:setup verify phone=${phone} code=${code}`;
            window.open(waHref(msg), '_blank', 'noopener');
            calcBox.dataset.verified='true';
            setStatus('Verificação feita pelo WhatsApp. Você já pode solicitar a criação.', 'ok');
          }
        }catch(e){ setStatus('Não foi possível verificar o código.', 'error'); }
      };

      btnSubmit.onclick = async ()=>{
        const verified = calcBox.dataset.verified === 'true';
        const payload = getSetupPayload();
        if(!payload.nome || !payload.cidade || !payload.startISO){ setStatus('Preencha nome, cidade, data e hora.', 'error'); return; }
        if(payload.preco <= 0){ setStatus('Informe um preço válido.', 'error'); return; }
        if(!$('ev-phone').value.trim()){ setStatus('Informe seu WhatsApp para vincular ao Dashboard.', 'error'); return; }
        setStatus('Enviando solicitação de criação…');

        try{
          const j = await fetchJson(`${BASE}/setup/create`, {
            method:'POST',
            body: JSON.stringify({ ...payload, verified }),
            headers:{'Content-Type':'application/json'}
          });
          if(j?.ok || j?.id){ setStatus('Evento pré-aprovado! Você receberá instruções por WhatsApp.', 'ok'); try{ location.href = '/app/login'; }catch{}; return; }
          throw new Error('create failed');
        } catch (err){
          // fallback via WA
          const msg = [
            `ingressai:setup create`,
            `categoria=${payload.categoriaKey}`,
            `nome=${payload.nome}`,
            `cidade=${payload.cidade}`,
            `quando=${payload.startISO}`,
            `local=${payload.local}`,
            `capacidade=${payload.capacidade}`,
            `preco=${payload.preco}`,
            `qtd=${payload.qtd}`,
            `taxa_fixa=${payload.feeFixed}`,
            `descricao=${payload.descricao || '-'}`,
            `verificado=${verified}`
          ].join('\n');
          window.open(waHref(msg), '_blank', 'noopener');
          setStatus('Abrimos seu WhatsApp com o resumo para criação rápida.', 'ok');
        }
      };
    }

    modelsBox.addEventListener('click', (e)=>{
      const b = e.target.closest('button.model'); if(!b) return;
      modelsBox.querySelectorAll('button.model').forEach(x=>x.setAttribute('aria-selected','false'));
      b.setAttribute('aria-selected','true');
      const key = b.dataset.key;
      applyPlan(key);
    });

    /* ========= FETCH events + fallback ========= */
    async function fetchEventosDoBackend(){
      let items = [];
      try{
        const j = await fetchJson(`${BASE}/events`);
        if (Array.isArray(j)) items = j;
        else if (Array.isArray(j?.items)) items = j.items;
        else if (Array.isArray(j?.events)) items = j.events;
        else if (j?.events) items = Object.values(j.events).flat();
      }catch(err){ console.warn('events load failed', err); }

      const mapped = (items || []).map(e=>{
        const IMG_RAW = e.imageUrl || (e.media && e.media.url) || e.image || e.bannerUrl || '';
        const IMG = abs(IMG_RAW);
        return {
          id: String(e.id),
          nome: e.title || e.nome || 'Evento',
          cidade: e.city || e.cidade || '',
          dataISO: e.date || e.startsAt || e.dataISO || new Date().toISOString(),
          localNome: e.venue || e.local || '',
          localUrl: 'https://maps.google.com/?q=' + encodeURIComponent(`${e.venue||e.local||''} ${e.city||e.cidade||''}`),
          categoria: e.category || 'IngressAI',
          status: e.statusLabel || 'Em breve',
          descricao: e.description || e.title || e.nome || '',
          img: IMG
        };
      });

      const fallback = [{
        id: 'hello-world-uberaba',
        nome: 'Hello World — Uberaba',
        cidade: 'Uberaba',
        dataISO: new Date(Date.now()+2*24*60*60*1000).toISOString(),
        localNome: 'Espaço Central',
        localUrl: 'https://maps.google.com/?q=' + encodeURIComponent('Espaço Central Uberaba'),
        categoria: 'IngressAI',
        status: 'Último lote',
        descricao: 'Hello World — Uberaba',
        img: ''
      }];

      eventos = mapped.length ? mapped : fallback;
      evIndex = Object.fromEntries(eventos.map(e=>[e.id,e]));
    }

    /* ========= INIT ========= */
    (async ()=>{
      renderModels(); applyPlan(null);
      await fetchEventosDoBackend();
      buildChips();
      renderCards();

      // if hash requests event
      if(location.hash.startsWith('#ev=')){
        const id = decodeURIComponent(location.hash.slice(4));
        const ev = evIndex[id];
        if(ev) openSheet(ev);
      }
    })();

  </script>
</body>
</html>
