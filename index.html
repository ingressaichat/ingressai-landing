<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="format-detection" content="telephone=no" />
  <title>IngressAI — Ingressos em minutos, direto no WhatsApp</title>
  <meta name="description" content="Compre ingressos em minutos pelo WhatsApp. Vitrine por cidade, checkout instantâneo, repasse T+0 e validação por QR Code." />
  <meta name="robots" content="index,follow,max-image-preview:large" />
  <meta name="theme-color" content="#2F7DD9" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="preload" as="image" href="/logo_ingressai.png" />
  <!-- jsPDF para gerar PDF no navegador -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js" defer></script>
  <style>
    :root{
      --phi:1.618;--s0:8px;--s1:calc(var(--s0)*var(--phi));--s2:calc(var(--s1)*var(--phi));
      --s3:calc(var(--s2)*var(--phi));--s4:calc(var(--s3)*var(--phi));
      --fs-0:1rem;--fs--1:calc(var(--fs-0)/var(--phi));
      --lh-compact:1.22;--lh:1.45;
      --ink:#0b1220;--muted:#5b6b86;--bg:#f6f8fc;--card:#ffffff;
      --blue-2:#2F7DD9;--shadow:0 10px 28px rgba(47,125,217,.14),0 2px 6px rgba(11,18,32,.08)
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/var(--lh) system-ui,Segoe UI,Roboto,Inter,sans-serif}
    a{color:inherit;text-decoration:none}
    :focus-visible{outline:none;box-shadow:0 0 0 2px rgba(74,147,240,.18)}
    .container{max-width:1040px;margin:0 auto;padding:0 var(--s3)}
    header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid #e7eefb}
    .head-inner{padding:.8rem 0;display:flex;align-items:center;gap:10px}
    .hero{padding:var(--s4) 0}
    h1{font-size:clamp(1.6rem,5.2vw,2.6rem);line-height:var(--lh-compact);margin:0 0 var(--s2) 0;font-weight:850;text-align:center}
    .badges{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:6px}
    .badge{display:inline-flex;align-items:center;gap:.5rem;font-weight:800;color:#445570}
    .badge img{height:18px}
    .cta-inline{display:flex;justify-content:center;margin-top:var(--s1)}
    .btn{min-height:44px;padding:.65rem 1.05rem;border-radius:999px;border:1px solid #d6e4ff;background:#fff;display:inline-flex;align-items:center;gap:8px;font-weight:800;box-shadow:0 6px 16px rgba(47,125,217,.16),0 2px 6px rgba(11,18,32,.08)}
    .btn--ghost{box-shadow:none;border-color:#e1e8f6}
    .btn[disabled]{opacity:.6;pointer-events:none}
    .muted{color:var(--muted)} .small{font-size:.92rem}
    hr.line{border:0;border-top:1px solid #eef3ff;margin:16px 0}
    /* Cards grid */
    .cards{display:grid;gap:var(--s1);grid-template-columns:1fr;margin:var(--s2) 0}
    @media(min-width:960px){.cards{grid-template-columns:1.1fr .9fr}}
    .card{background:#fff;border:1px solid #eaf1ff;border-radius:16px;box-shadow:var(--shadow);padding:var(--s2)}
    /* Status */
    .status{padding:10px 12px;border-radius:10px;border:1px solid #e7eefb;background:#fff;display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:10px;background:#999}.ok{background:#12a150}.warn{background:#d97706}.err{background:#c2410c}
    /* Inputs */
    .grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    input,select{width:100%;padding:.7rem .8rem;border:1px solid #e5ecff;border-radius:12px;font:inherit}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    /* Ticket preview */
    .ticket-preview{display:grid;place-items:center;border:1px dashed #dbe5ff;border-radius:12px;min-height:240px;background:#fff}
    .ticket-preview img{max-width:100%;height:auto;border-radius:8px}
    /* Vitrine compacta */
    .feature-grid{display:grid;gap:var(--s0);grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(min-width:900px){.feature-grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .feature{background:#fff;border:1px solid #e5ecff;border-radius:12px;padding:calc(var(--s0)*1.25);display:flex;flex-direction:column;align-items:center;gap:var(--s0)}
    .feature strong{font-weight:800}
    /* Organizador (corrigido estilos mínimos) */
    .model-grid{display:flex;gap:8px;flex-wrap:wrap}
    .model{appearance:none;border:1px solid #e5ecff;background:#fff;border-radius:999px;padding:.55rem .9rem;font-weight:800;cursor:pointer}
    .model[aria-selected="true"]{background:#2F7DD9;color:#fff;border-color:#2F7DD9}
    .fee-row{margin:.6rem 0 .2rem 0;display:none}
    .fee-row.is-visible{display:block}
    .fee-chip{display:inline-flex;align-items:center;border:1px solid #e5ecff;border-radius:999px;padding:.25rem .7rem;font-weight:800;background:#fff}
    .org-panel.is-disabled{opacity:.6;pointer-events:none}
    /* Bottom sheet (detalhes do evento) */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(11,18,32,.36);opacity:0;pointer-events:none;transition:opacity .2s}
    .sheet-backdrop.is-open{opacity:1;pointer-events:auto}
    .sheet{position:fixed;left:0;right:0;bottom:0;height:72vh;max-height:760px;background:#fff;border-top-left-radius:24px;border-top-right-radius:24px;box-shadow:0 -24px 48px rgba(11,18,32,.16);transform:translateY(100%);transition:transform .28s cubic-bezier(.2,.7,.2,1);display:flex;flex-direction:column;padding:var(--s2);z-index:40}
    .sheet.is-open{transform:translateY(0)}
    .sheet-media{width:100%;aspect-ratio:1.35;border:1px solid #eaf1ff;border-radius:16px;background:radial-gradient(600px 280px at 20% 0%,rgba(47,125,217,.12),transparent 60%),linear-gradient(180deg,#fff,#f5f9ff);margin:.5rem 0 1rem;overflow:hidden}
    .sheet-media img{width:100%;height:100%;object-fit:cover}
    .status-chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #e6eaf6;border-radius:999px;padding:.25rem .55rem;font-weight:800;font-size:.85rem}
    .status-chip .dot{width:.5rem;height:.5rem;border-radius:50%}
    .status-chip.low{color:#b64848;border-color:#ffdede;background:#fff7f7}
    .status-chip.soon{color:#1B5FB3;border-color:#cfe3ff;background:#f3f8ff}
    .status-chip.sold{color:#6b7280;border-color:#e3e4ea;background:#fafbfc}
    .sheet-close{position:absolute;right:10px;top:10px;appearance:none;background:#fff;border:1px solid #ffd6d6;color:#c94747;border-radius:14px;padding:.6rem;display:grid;place-items:center;box-shadow:0 8px 20px rgba(201,71,71,.18)}
  </style>
</head>
<body>
  <header role="banner">
    <div class="container head-inner">
      <img src="/logo_ingressai.png" alt="IngressAI" width="36" height="36" />
      <strong>IngressAI</strong>
    </div>
  </header>

  <main class="container" role="main">
    <!-- HERO -->
    <section class="hero" aria-labelledby="hero-title">
      <div style="text-align:center">
        <div class="badges" aria-label="Selos de plataforma">
          <span class="badge" aria-label="Powered by Meta Business Platform">
            <img src="/meta.png" alt="Meta" /><span>Meta Business Platform</span>
          </span>
          <span class="badge" aria-label="WhatsApp Business API">
            <img src="/whatsapp_business.png" alt="WhatsApp Business" /><span>WhatsApp Business API</span>
          </span>
        </div>
        <h1 id="hero-title">Crie eventos com a IngressAI.</h1>
        <p class="muted">Vitrine por cidade, checkout no WhatsApp, repasse T+0 e validação por QR.</p>
      </div>
      <div class="cta-inline">
        <a href="#painel" class="btn" aria-label="Ir para o painel de testes">Testar agora</a>
      </div>
    </section>

    <!-- PROVAS -->
    <section class="card" aria-labelledby="proofs-title">
      <h2 id="proofs-title" class="sr-only" style="position:absolute;left:-9999px">Provas de valor</h2>
      <div class="feature-grid" aria-label="Provas de valor">
        <div class="feature"><strong>Venda automatizada</strong><small class="muted">via WhatsApp</small></div>
        <div class="feature"><strong>Repasse imediato</strong><small class="muted">via Pix</small></div>
        <div class="feature"><strong>QR antifraude</strong><small class="muted">+ validador web</small></div>
        <div class="feature"><strong>Comandos &amp; Dashboard</strong><small class="muted">Compradores &amp; acesso</small></div>
      </div>
    </section>

    <!-- PAINEL -->
    <section id="painel" class="cards" aria-labelledby="painel-title">
      <h2 id="painel-title" class="sr-only" style="position:absolute;left:-9999px">Painel de Testes</h2>

      <!-- Coluna A -->
      <div class="card">
        <h3>Status do Backend</h3>
        <div id="statusBox" class="status" style="margin-top:8px">
          <span class="dot warn"></span>
          <span id="statusText">Conectando…</span>
        </div>
        <div class="actions">
          <button id="btnRefresh" class="btn btn--ghost">Recarregar status</button>
          <a class="btn btn--ghost" id="btnRoutes" href="#" target="_blank" rel="noopener">Ver rotas</a>
        </div>
        <p class="muted small" style="margin-top:8px">API: <span id="apiBaseTxt"></span></p>

        <hr class="line">
        <h3>Comprar (atalho por lista)</h3>
        <div style="display:grid;gap:10px;margin-top:8px">
          <div class="grid2">
            <div>
              <label for="comprarQtd">Qtd</label>
              <select id="comprarQtd"><option>1</option><option>2</option><option>3</option><option>4</option></select>
            </div>
            <div>
              <label for="comprarNome">Seu nome</label>
              <input id="comprarNome" placeholder="Ex: Ana Maria" />
            </div>
          </div>
          <div class="actions">
            <button id="btnAbrirWA" class="btn">Abrir WhatsApp</button>
            <button id="btnCopiarMSG" class="btn btn--ghost">Copiar mensagem</button>
            <small class="muted">Dica: mande “oi” para o bot — ele envia a <b>lista interativa</b>.</small>
          </div>
        </div>
      </div>

      <!-- Coluna B -->
      <div class="card">
        <h3>Emitir Ingresso (teste)</h3>
        <div style="display:grid;gap:10px;margin-top:8px">
          <div class="grid2">
            <div>
              <label for="title2">Título do evento</label>
              <input id="title2" placeholder="Ex: Evento Genérico 01" />
            </div>
            <div>
              <label for="when2">Data • Hora</label>
              <input id="when2" placeholder="Ex: 28 Ago 25 • 21:00" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="venue2">Local</label>
              <input id="venue2" placeholder="Ex: Espaço A" />
            </div>
            <div>
              <label for="buyer2">Nome do comprador</label>
              <input id="buyer2" placeholder="Ex: Ana Maria" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="code2">Código (opcional)</label>
              <input id="code2" placeholder="Ex: TKT-0001" />
            </div>
            <div>
              <label for="phone2">Telefone (DDI + DDD + número)</label>
              <input id="phone2" placeholder="Ex: 5534999992747" />
            </div>
          </div>
          <div class="actions">
            <button id="btnPreview2" class="btn">Gerar prévia</button>
          </div>
          <div id="previewBox2" class="ticket-preview" style="margin-top:8px">
            <span class="muted small">A prévia aparece aqui…</span>
          </div>
          <div class="actions">
            <button id="btnPDF2" class="btn" disabled>Baixar PDF</button>
            <button id="btnEnviarWA2" class="btn btn--ghost" disabled>Enviar pelo WhatsApp</button>
            <a id="btnValidar2" class="btn btn--ghost" href="#" target="_blank" rel="noopener" style="display:none">Abrir validador</a>
          </div>
          <p class="muted small">O PDF é montado no navegador a partir da imagem PNG do backend.</p>
        </div>
      </div>
    </section>

    <!-- Bottom sheet -->
    <div class="sheet-backdrop" id="sheet-backdrop" aria-hidden="true"></div>
    <aside class="sheet" id="sheet" aria-hidden="true" role="dialog" aria-modal="true">
      <button class="sheet-close" id="sheet-close" aria-label="Fechar detalhes">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 6L18 18M18 6L6 18" /></svg>
      </button>
      <div class="sheet-body" id="sheet-body"></div>
    </aside>
  </main>

  <footer role="contentinfo" style="padding:24px 0">
    <div class="container" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
      <div class="muted small">© IngressAI — CNPJ 42.948.399/0001-87</div>
      <div style="display:flex;gap:10px">
        <a class="btn btn--ghost" href="/politica.html">Privacidade</a>
        <a class="btn btn--ghost" href="/termos.html">Termos</a>
        <a class="btn btn--ghost" href="/excluir.html">Excluir meus dados</a>
      </div>
    </div>
  </footer>

  <!-- APP -->
  <script>
    // ===== Config =====
    const WHATSAPP_NUMBER='5534999992747'; // número público para atalho
    const API_BASE = (new URLSearchParams(location.search).get('api'))
      || 'https://ingressai-backend-production.up.railway.app'; // padrão
    const $ = (q)=>document.querySelector(q);
    const fmtPhone = (v)=> String(v||"").replace(/\D+/g,"");
    const randCode = ()=> "TKT-" + (Date.now().toString().slice(-6));
    const waLink = (to, text)=> `https://wa.me/${fmtPhone(to)}?text=${encodeURIComponent(text||"")}`;

    // ===== UI helpers =====
    function setStatus(state, text){
      const dot = $("#statusBox .dot"), label = $("#statusText");
      if(!dot || !label) return;
      label.textContent = text;
      dot.classList.remove("ok","warn","err"); dot.classList.add(state);
    }
    async function fetchBlob(url){
      const r = await fetch(url, { mode:"cors" });
      if(!r.ok) throw new Error("Falha ao carregar imagem ("+r.status+")");
      return await r.blob();
    }
    async function makePdfFromPng(pngBlob, fileName="ticket.pdf"){
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:"pt", format:"a4" });
      const url = URL.createObjectURL(pngBlob);
      const img = new Image(); img.src = url;
      await new Promise((res,rej)=>{ img.onload = res; img.onerror = rej; });
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 36, maxW = pageW - margin*2, maxH = pageH - margin*2;
      let w = img.naturalWidth, h = img.naturalHeight;
      const r = Math.min(maxW/w, maxH/h); w *= r; h *= r;
      pdf.addImage(img, "PNG", (pageW-w)/2, (pageH-h)/2, w, h);
      pdf.save(fileName);
      URL.revokeObjectURL(url);
    }

    // ===== Status backend =====
    $("#apiBaseTxt").textContent = API_BASE;
    async function refreshStatus(){
      try{
        setStatus("warn","Conectando…");
        const r = await fetch(API_BASE + "/health", { mode:"cors" });
        if(!r.ok) throw new Error("HTTP "+r.status);
        const j = await r.json();
        setStatus("ok", `Online • uptime ${Math.round(j.uptime||0)}s`);
        const routes = $("#btnRoutes"); if(routes) routes.href = API_BASE + "/__routes";
      }catch(e){
        console.error(e);
        setStatus("err","Offline (verifique API/CORS)");
      }
    }
    $("#btnRefresh")?.addEventListener("click", refreshStatus);
    refreshStatus();

    // ===== Atalho de compra =====
    $("#btnAbrirWA")?.addEventListener("click", ()=>{
      const qtd = ($("#comprarQtd")?.value)||"1";
      const nome = ($("#comprarNome")?.value)||"";
      const msg = `Olá! Quero comprar ingresso. Quantidade: ${qtd}. Meu nome: ${nome}`;
      window.open(waLink(WHATSAPP_NUMBER, msg), "_blank", "noopener,noreferrer");
    });
    $("#btnCopiarMSG")?.addEventListener("click", async ()=>{
      const qtd = ($("#comprarQtd")?.value)||"1";
      const nome = ($("#comprarNome")?.value)||"";
      const msg = `Olá! Quero comprar ingresso. Quantidade: ${qtd}. Meu nome: ${nome}`;
      try{ await navigator.clipboard.writeText(msg); alert("Mensagem copiada!"); }catch{ alert("Não foi possível copiar."); }
    });

    // ===== Emissão =====
    const buildPreviewUrl = ({title,when,venue,buyer,code})=>{
      const u = new URL(API_BASE + "/tickets/preview.png");
      if(title) u.searchParams.set("title", title);
      if(when)  u.searchParams.set("when", when);
      if(venue) u.searchParams.set("venue", venue);
      if(buyer) u.searchParams.set("buyer", buyer);
      if(code)  u.searchParams.set("code", code);
      return u.toString();
    };

    let lastPreview = { blob:null, code:null, fields:null };
    $("#btnPreview2")?.addEventListener("click", async ()=>{
      const title = $("#title2").value.trim();
      const when  = $("#when2").value.trim();
      const venue = $("#venue2").value.trim();
      const buyer = $("#buyer2").value.trim() || "Cliente";
      const codeI = $("#code2").value.trim() || randCode();
      if(!title || !when || !venue){ alert("Preencha Título, Data•Hora e Local."); return; }
      $("#code2").value = codeI;

      const url = buildPreviewUrl({ title, when, venue, buyer, code: codeI });
      const box = $("#previewBox2");
      box.innerHTML = '<span class="muted small">Gerando…</span>';
      try{
        const blob = await fetchBlob(url);
        const imgUrl = URL.createObjectURL(blob);
        box.innerHTML = `<img alt="Prévia do ingresso" src="${imgUrl}" />`;
        $("#btnPDF2").disabled = false;
        $("#btnEnviarWA2").disabled = false;
        const v = $("#btnValidar2");
        if(v){ v.style.display = ""; v.href = API_BASE + "/validate?c=" + encodeURIComponent(codeI); }
        lastPreview = { blob, code: codeI, fields: { title, when, venue, buyer } };
      }catch(e){
        console.error(e);
        box.innerHTML = `<span class="small" style="color:#c2410c">Falha ao gerar prévia.</span>`;
        $("#btnPDF2").disabled = true;
        $("#btnEnviarWA2").disabled = true;
        const v = $("#btnValidar2"); if(v) v.style.display = "none";
        lastPreview = { blob:null, code:null, fields:null };
      }
    });

    $("#btnPDF2")?.addEventListener("click", async ()=>{
      if(!lastPreview.blob){ alert("Gere a prévia primeiro."); return; }
      const buyer = ($("#buyer2").value||"Cliente").trim() || "Cliente";
      const code  = lastPreview.code || "TICKET";
      await makePdfFromPng(lastPreview.blob, `ingresso_${code}_${buyer}.pdf`);
    });

    $("#btnEnviarWA2")?.addEventListener("click", async ()=>{
      const to = ($("#phone2").value||"").trim();
      if(!to){ alert("Informe o telefone do destinatário."); return; }
      if(!lastPreview.fields){ alert("Gere a prévia primeiro."); return; }

      // link do PDF servido pelo backend
      const pdfUrl = new URL(API_BASE + "/tickets/preview.pdf");
      const f = lastPreview.fields;
      pdfUrl.searchParams.set('title', f.title);
      pdfUrl.searchParams.set('when',  f.when);
      pdfUrl.searchParams.set('venue', f.venue);
      pdfUrl.searchParams.set('buyer', f.buyer);
      pdfUrl.searchParams.set('code',  lastPreview.code);

      const payload = {
        to: to,
        link: String(pdfUrl),
        filename: `${lastPreview.code}.pdf`,
        caption: `${f.title} — ${f.buyer}`
      };

      try{
        const r = await fetch(API_BASE + "/test/send-ticket", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload),
          mode:"cors"
        });
        const j = await r.json().catch(()=>({}));
        if(r.ok && j && j.ok){ alert("Ingresso enviado por WhatsApp!"); }
        else{ console.error(j); alert("Falha ao enviar. Veja os logs do backend."); }
      }catch(e){
        console.error(e);
        alert("Erro de rede ao chamar o backend.");
      }
    });

    // ===== Bottom sheet infra (reservado para vitrine / futuro) =====
    const sheet=document.getElementById('sheet');
    const sheetBody=document.getElementById('sheet-body');
    const sheetBackdrop=document.getElementById('sheet-backdrop');
    const sheetClose=document.getElementById('sheet-close');
    function closeSheet(){sheet.classList.remove('is-open');sheetBackdrop.classList.remove('is-open');sheet.removeAttribute('aria-labelledby');sheet.setAttribute('aria-hidden','true');sheetBackdrop.setAttribute('aria-hidden','true');document.body.style.overflow=''}
    sheetClose?.addEventListener('click',closeSheet);sheetBackdrop?.addEventListener('click',closeSheet);
    document.addEventListener('keydown',e=>{if(e.key==='Escape')closeSheet()});
  </script>
</body>
</html>
